<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>ç‚¹æ¤œã‚¢ãƒ—ãƒªï¼ˆå®Œæˆç‰ˆï¼‰</title>
  <link rel="icon" type="image/png" href="ã‚¢ãƒ—ãƒªãƒ­ã‚´.png">
  <link rel="apple-touch-icon" href="ã‚¢ãƒ—ãƒªãƒ­ã‚´.png">
  <meta name="theme-color" content="#007bff">
  <script src="https://unpkg.com/@zxing/library@latest"></script>
  <style>
    :root { --brand:#007bff; --ok:#28a745; --danger:#e55353; --info:#17a2b8; --drive:#6f42c1; }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#f5f6f8;text-align:center;padding:16px}
    h1{margin:8px 0 12px;color:#222}
    .btn{margin:6px;padding:12px 20px;font-size:16px;border:none;border-radius:10px;background:var(--brand);color:#fff;box-shadow:0 2px 6px rgba(0,0,0,.1)}
    .btn:active{transform:translateY(1px)}
    .btn.sub{background:#6c757d; padding:8px 16px; font-size:14px;}
    .btn.info{background:var(--info)}
    .btn.drive{background:var(--drive)}
    .card{max-width:480px;margin:8px auto;background:#fff;border-radius:12px;padding:12px;box-shadow:0 2px 10px rgba(0,0,0,.06);text-align:left}
    
    video, canvas {width:100%;max-width:480px;border-radius:10px;background:#000; display:none;}
    
    #status{margin-top:8px;color:#c0392b; font-weight:bold;}
    #serial{margin-top:6px;color:var(--ok);font-weight:600}
    
    /* ç”»é¢åˆ‡ã‚Šæ›¿ãˆç”¨ */
    .view-section { display:none; }
    .view-section.active { display:block; }

    /* å†™çœŸãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ */
    #photoPreview { width:100%; border-radius:10px; margin-bottom:10px; border:2px solid #ccc; display:none;}

    /* ãŠçŸ¥ã‚‰ã›æ¬„ */
    .news-box {
      background-color: #fff3cd; border-left: 5px solid #ffc107;
      padding: 10px; margin-top: 15px; text-align: left; border-radius: 4px; display: none;
    }
    .news-title { font-weight:bold; color:#856404; font-size:14px; margin-bottom:6px; border-bottom:1px solid rgba(0,0,0,0.1); padding-bottom:4px;}
    .news-content ul { padding-left: 20px; margin: 0; }
    .news-content li { margin-bottom: 4px; font-size:14px;}
  </style>
</head>
<body>

<div id="summaryCard" class="card" style="text-align:center; margin-bottom:12px;">
  <h2>ç‚¹æ¤œé€²æ—</h2>
  <p>äºˆå®š: <span id="planCount">-</span> / å®Œäº†: <span id="doneCount">-</span> / æ®‹: <span id="remainCount">-</span></p>
</div>

<div id="view-top" class="view-section active">
  <h1>ç‚¹æ¤œè€…ã‚’é¸æŠ</h1>
  <div class="card" style="text-align:center">
    <div>
        <button class="btn" onclick="startFlow('ç¾½æŸ“')">ç¾½æŸ“</button>
        <button class="btn" onclick="startFlow('æ¢…åŸ')">æ¢…åŸ</button>
        <button class="btn" onclick="startFlow('æ˜ç”°å·')">æ˜ç”°å·</button>
        <button class="btn" onclick="startFlow('å±±å£')">å±±å£</button>
        <button class="btn" onclick="startFlow('ä½è—¤')">ä½è—¤</button>
        <button class="btn" onclick="startFlow('é«™æ©‹')">é«™æ©‹</button>
        <button class="btn" onclick="startFlow('é‡£å·')">é‡£å·</button>
    </div>
    <hr style="margin: 15px 0; border: 0; border-top: 1px solid #eee;">
    
    <div style="display:flex; justify-content:center; gap:8px;">
        <button class="btn sub" style="flex:1;" onclick="showHistory()">å±¥æ­´</button>
        <button class="btn sub" style="flex:1;" onclick="openDashboard()">æœªé€ä¿¡</button>
    </div>
    
    <div style="margin-top:8px;">
        <button class="btn info" style="width:100%;" onclick="openPastHistory()">ğŸ“‚ éå»ã®å±¥æ­´</button>
    </div>

    <div style="margin-top:8px;">
        <button class="btn drive" style="width:100%;" onclick="openPhotoFolder()">ğŸ“· ä¿å­˜ã•ã‚ŒãŸå†™çœŸã‚’è¦‹ã‚‹</button>
    </div>

    <div id="newsArea" class="news-box">
        <div class="news-title">ğŸ“¢ ãŠçŸ¥ã‚‰ã›</div>
        <div id="newsText" class="news-content"></div>
    </div>
  </div>
</div>

<div id="view-camera" class="view-section">
    <div class="card" style="text-align:center;">
        <h3>â‘  ãƒˆãƒƒãƒ—ãƒ¦ãƒ‹ãƒƒãƒˆè£…ç€æ¸ˆã®éŠæŠ€å°ã‚’æ’®å½±</h3>
        
        <video id="cameraVideo" autoplay playsinline></video>
        <img id="photoPreview" />
        <canvas id="cameraCanvas"></canvas>
        
        <div style="margin-top:10px;">
            <button id="btnShutter" class="btn" onclick="takePhoto()">ğŸ“· æ’®å½±ã™ã‚‹</button>
            
            <button id="btnSkip" class="btn sub" style="background:#17a2b8;" onclick="skipPhoto()">â­ï¸ QRã‚³ãƒ¼ãƒ‰èª­è¾¼ã¸</button>

            <button id="btnRetake" class="btn sub" style="display:none;" onclick="retakePhoto()">æ’®ã‚Šç›´ã™</button>
            <button id="btnNextScan" class="btn ok" style="display:none;" onclick="goToScan()">æ¬¡ã¸é€²ã‚€</button>
        </div>
        
        <div style="margin-top:15px; border-top:1px solid #eee; padding-top:10px;">
            <button class="btn sub" style="background:#999;" onclick="resetToTop()">ä¸­æ­¢ã—ã¦æˆ»ã‚‹</button>
        </div>
    </div>
</div>

<div id="view-scan" class="view-section">
  <div class="card">
    <h3>â‘¡ QRã‚’ã‚¹ã‚­ãƒ£ãƒ³</h3>
    <div class="toolbar" style="justify-content:center;">
      <button id="btnTorch" class="btn sub" style="display:none" onclick="onTorchClick()">ğŸ”¦ ãƒ©ã‚¤ãƒˆ</button>
      <button class="btn sub" onclick="manualEntry()">æ‰‹å…¥åŠ›</button>
    </div>

    <video id="scannerVideo" autoplay playsinline style="display:block;"></video>
    <div id="status">QRã‚³ãƒ¼ãƒ‰ã‚’ã‹ã–ã—ã¦ãã ã•ã„â€¦</div>
    <div id="serial"></div>
  </div>
</div>

<div id="view-sending" class="view-section">
    <div class="card" style="text-align:center; padding:40px;">
        <h2 id="msgSending">å‡¦ç†ä¸­...</h2>
        <p id="msgDetail">ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†ã—ã¦ã„ã¾ã™ã€‚<br>ç”»é¢ã‚’é–‰ã˜ãªã„ã§ãã ã•ã„ã€‚</p>
        <div style="font-size:30px;">â³</div>
    </div>
</div>

<script>
/** ====== è¨­å®š ====== */
// GASã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªURL
const GAS_API_URL = "https://script.google.com/macros/s/AKfycbzXAahoozZAc92FjMxVZ5RVAx6iWCeBLSpnQUYBRgAg6w7LlDwUxze6Rm7aV5yPc7DKMg/exec";

// å†™çœŸãƒ•ã‚©ãƒ«ãƒ€URL
const PHOTO_FOLDER_URL = "https://drive.google.com/drive/u/0/folders/1Z1q480XPFBFBoIpdFvbn4K4yto9r_jOA";

const FORM_URL_BASE = "https://docs.google.com/forms/d/e/1FAIpQLSchpdG2NLN2uV5yAxyZC-k_xhFyem_KQDrhNmTMEGJGnsu13A/viewform";
const ENTRY_SERIAL   = "entry.797900650"; 
const ENTRY_INSPECT  = "entry.983313981";

/* ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆé€£æºURL */
const DASHBOARD_URL = "https://docs.google.com/spreadsheets/d/1YgPxoZnkJO402iSigrX893vd1ExJEPJobu7-_GzpW0w/edit?gid=2043079432#gid=2043079432";
const COUNTS_CSV_URL = "https://docs.google.com/spreadsheets/d/1YgPxoZnkJO402iSigrX893vd1ExJEPJobu7-_GzpW0w/export?format=csv&gid=2043079432&range=B1:B3";
const NEWS_CSV_URL   = "https://docs.google.com/spreadsheets/d/1YgPxoZnkJO402iSigrX893vd1ExJEPJobu7-_GzpW0w/export?format=csv&gid=1607150139&range=A1:A5";
const PAST_HISTORY_URL = "https://docs.google.com/spreadsheets/d/1w75zFfpDTkZ2ruyQz1g5f8_cnTe_SnIBCqKkOTuy9yc/edit?usp=drive_link";

/** å¤‰æ•° */
let inspector='';
let codeReader;
let streamTrack=null;
let capturedImageBase64 = null; 

/* === 1. æ’®å½±ãƒ•ãƒ­ãƒ¼é–‹å§‹ === */
function startFlow(name){
    inspector = name;
    switchView('view-camera');
    startCamera(); 
}

/* === ç”»é¢åˆ‡ã‚Šæ›¿ãˆãƒ˜ãƒ«ãƒ‘ãƒ¼ === */
function switchView(id){
    document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
    document.getElementById(id).classList.add('active');
}

/* === ã‚«ãƒ¡ãƒ©å‡¦ç† === */
async function startCamera(){
    const video = document.getElementById('cameraVideo');
    video.style.display = 'block';
    document.getElementById('photoPreview').style.display = 'none';
    
    // ãƒœã‚¿ãƒ³åˆæœŸåŒ–
    document.getElementById('btnShutter').style.display = 'inline-block';
    document.getElementById('btnSkip').style.display = 'inline-block';
    document.getElementById('btnRetake').style.display = 'none';
    document.getElementById('btnNextScan').style.display = 'none';

    try {
        const stream = await navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: 'environment' }, 
            audio: false 
        });
        video.srcObject = stream;
    } catch(err) {
        alert("ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã§ãã¾ã›ã‚“ã§ã—ãŸ: " + err);
    }
}

function takePhoto(){
    const video = document.getElementById('cameraVideo');
    const canvas = document.getElementById('cameraCanvas');
    const context = canvas.getContext('2d');
    
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    context.drawImage(video, 0, 0, canvas.width, canvas.height);
    
    capturedImageBase64 = canvas.toDataURL('image/jpeg', 0.8);
    
    const preview = document.getElementById('photoPreview');
    preview.src = capturedImageBase64;
    preview.style.display = 'block';
    video.style.display = 'none';
    
    document.getElementById('btnShutter').style.display = 'none';
    document.getElementById('btnSkip').style.display = 'none';
    document.getElementById('btnRetake').style.display = 'inline-block';
    document.getElementById('btnNextScan').style.display = 'inline-block';
    
    if(video.srcObject) video.srcObject.getTracks().forEach(t => t.stop());
}

function retakePhoto(){
    capturedImageBase64 = null;
    startCamera(); 
}

function skipPhoto(){
    capturedImageBase64 = null; 
    goToScan();
}

/* === 2. QRã‚¹ã‚­ãƒ£ãƒ³ã¸é€²ã‚€ === */
function goToScan(){
    const video = document.getElementById('cameraVideo');
    if(video.srcObject) video.srcObject.getTracks().forEach(t => t.stop());

    switchView('view-scan');
    startScanProcess();
}

/* === QRã‚¹ã‚­ãƒ£ãƒ³å‡¦ç† === */
function startScanProcess(){
    codeReader = new ZXing.BrowserMultiFormatReader();
    const vid = document.getElementById('scannerVideo');
    
    codeReader.decodeOnceFromConstraints({ video:{ facingMode:'environment' } }, vid)
    .then(res => {
        const raw = res.getText();
        const formatted = parseSerial(raw);
        document.getElementById('serial').textContent = 'èª­å–å®Œäº†: ' + formatted;
        
        handleComplete(formatted);
    })
    .catch(err => {
        document.getElementById('status').textContent = 'ã‚¨ãƒ©ãƒ¼: ' + err;
    });

    setTimeout(() => {
        try{
             const track = vid.srcObject.getVideoTracks()[0];
             if(track && track.getCapabilities().torch){
                 streamTrack = track;
                 document.getElementById('btnTorch').style.display = 'inline-block';
             }
        }catch(e){}
    }, 600);
}

/* === 3. ãƒ‡ãƒ¼ã‚¿é€ä¿¡å‡¦ç† === */
async function handleComplete(serial){
    cleanupStream();
    switchView('view-sending');

    if(capturedImageBase64){
        document.getElementById('msgSending').textContent = "é€ä¿¡ä¸­...";
        document.getElementById('msgDetail').textContent = "å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ã„ã¾ã™";
        
        if(GAS_API_URL && GAS_API_URL.startsWith("https")){
            try {
                // â˜…ã“ã“ã‚’å¤‰æ›´ï¼šãƒ•ã‚¡ã‚¤ãƒ«åã«æ‹…å½“è€…åã‚’çµåˆ
                const finalFileName = inspector + '_' + serial;

                await fetch(GAS_API_URL, {
                    method: "POST",
                    body: JSON.stringify({
                        image: capturedImageBase64,
                        filename: finalFileName, // æ‹…å½“è€…_è£½é€ ç•ªå·
                        inspector: inspector
                    })
                });
            } catch(e) {
                console.error("Upload failed", e);
                alert("å†™çœŸã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸãŒã€ãƒ•ã‚©ãƒ¼ãƒ ã¸é€²ã¿ã¾ã™ã€‚");
            }
        } else {
            alert("GASã®URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚å†™çœŸã¯ä¿å­˜ã•ã‚Œã¾ã›ã‚“ã€‚");
        }
    } else {
        document.getElementById('msgSending').textContent = "å‡¦ç†å®Œäº†";
        document.getElementById('msgDetail').textContent = "ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‹ãã¾ã™...";
        await new Promise(r => setTimeout(r, 500));
    }

    saveHistory(serial);
    openForm(serial);
    
    setTimeout(() => {
        location.reload();
    }, 1000);
}

/* === æ—¢å­˜ã®è£œåŠ©é–¢æ•° === */
function openForm(serial){
  const url = `${FORM_URL_BASE}?usp=pp_url&${ENTRY_SERIAL}=${encodeURIComponent(serial)}&${ENTRY_INSPECT}=${encodeURIComponent(inspector)}`;
  const win = window.open(url, '_blank');
  if(!win){ 
      alert('é€ä¿¡å®Œäº†ã€‚ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‹ãã¾ã™ã€‚\n(ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸå ´åˆã¯æ‰‹å‹•ã§é–‹ã„ã¦ãã ã•ã„)');
      location.href = url;
  }
}

function resetToTop(){
    cleanupStream();
    location.reload();
}

function cleanupStream(){
    try{ codeReader && codeReader.reset(); }catch(e){}
    try{
        const v = document.getElementById('cameraVideo');
        if(v.srcObject) v.srcObject.getTracks().forEach(t=>t.stop());
    }catch(e){}
    try{
        const v = document.getElementById('scannerVideo');
        if(v.srcObject) v.srcObject.getTracks().forEach(t=>t.stop());
    }catch(e){}
}

/* ... ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã€å±¥æ­´ã€ãƒ‘ãƒ¼ã‚¹ãƒ­ã‚¸ãƒƒã‚¯ ... */
function saveHistory(serial){
  const hist = JSON.parse(localStorage.getItem('history')||'[]');
  hist.unshift({time:new Date().toLocaleString(), serial, inspector});
  localStorage.setItem('history', JSON.stringify(hist.slice(0,500)));
}
function showHistory(){ window.open("https://docs.google.com/spreadsheets/d/1YgPxoZnkJO402iSigrX893vd1ExJEPJobu7-_GzpW0w/edit?gid=811114478#gid=811114478", "_blank"); }
function openDashboard(){ window.open(DASHBOARD_URL, "_blank"); }
function openPastHistory(){ window.open(PAST_HISTORY_URL, "_blank"); }
function openPhotoFolder(){ window.open(PHOTO_FOLDER_URL, "_blank"); }
function manualEntry(){ openForm(''); }
function onTorchClick(){
  if(streamTrack){
    const s = streamTrack.getSettings();
    streamTrack.applyConstraints({advanced:[{torch:!s.torch}]});
  }
}
async function loadData(){
  try{
    const res = await fetch(COUNTS_CSV_URL, {cache:"no-store"});
    if(res.ok){
       const r = (await res.text()).trim().split(/\r?\n/).map(x=>x.replace(/^"|"$|,/g,"").trim());
       document.getElementById("planCount").textContent=r[0]||0;
       document.getElementById("doneCount").textContent=r[1]||0;
       document.getElementById("remainCount").textContent=r[2]||Math.max(0,(r[0]||0)-(r[1]||0));
    }
    const nRes = await fetch(NEWS_CSV_URL, {cache:"no-store"});
    if(nRes.ok){
       const rows = (await nRes.text()).trim().split(/\r?\n/).map(x=>x.replace(/^"|"$|,/g,"").trim()).filter(x=>x);
       if(rows.length){
           document.getElementById("newsText").innerHTML = '<ul>' + rows.map(x=>`<li>${x}</li>`).join('') + '</ul>';
           document.getElementById("newsArea").style.display='block';
       }
    }
  }catch(e){}
}
window.addEventListener("load", loadData);

function yearDigitsToLetter(yyStr){
  const yy = Number(String(yyStr).replace(/\D/g, ''));
  if (!Number.isFinite(yy)) return '?';
  const baseIdx = 'H'.charCodeAt(0) - 'A'.charCodeAt(0);
  const idx = ((yy - 20) % 26 + 26) % 26;
  return String.fromCharCode('A'.charCodeAt(0) + ((baseIdx + idx) % 26));
}
function parseSerial(t){
  if (t == null) return t;
  t = String(t).trim();
  const head = t[0]?.toUpperCase() || '';
  const yyDigits = t.length >= 6 ? t.slice(4, 6) : '';
  const yearLetter = yearDigitsToLetter(yyDigits);
  const tail6 = (t.match(/(\d{6})$/) || [,''])[1] || '';
  const makerMatch = /^[PMCK].([A-Z]{2})/i.exec(t);
  const maker = makerMatch ? makerMatch[1].toUpperCase() : '';
  if (head === 'P' || head === 'M'){
    if (maker && yearLetter !== '?' && tail6){
      const prefix = (head === 'M') ? 'M' : '';
      return `${maker}-${yearLetter} ${prefix}${tail6}`;
    }
    return t; 
  }
  if (head === 'C' || head === 'K'){
    if (/[0321]/.test(t[1] || '') && maker && yearLetter !== '?' && tail6){
      return `${maker}-${yearLetter} ${head}${tail6}`;
    }
    return t; 
  }
  return t;
}
</script>
</body>
</html>
