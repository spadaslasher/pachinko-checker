<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>ç‚¹æ¤œçµæœå ±å‘Šã‚¢ãƒ—ãƒªï¼ˆå¹´ã‚³ãƒ¼ãƒ‰è‡ªå‹•åˆ¤å®šãƒ»çµ±ä¸€é·ç§»ï¼‰</title>
  <link rel="icon" type="image/png" href="ã‚¢ãƒ—ãƒªãƒ­ã‚´.png">
  <link rel="apple-touch-icon" href="ã‚¢ãƒ—ãƒªãƒ­ã‚´.png">
  <meta name="theme-color" content="#007bff">
  <script src="https://unpkg.com/@zxing/library@latest"></script>
  <style>
    :root { --brand:#007bff; --ok:#28a745; --danger:#e55353; --info:#17a2b8; }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#f5f6f8;text-align:center;padding:16px}
    h1{margin:8px 0 12px;color:#222}
    .btn{margin:6px;padding:10px 16px;font-size:16px;border:none;border-radius:10px;background:var(--brand);color:#fff;box-shadow:0 2px 6px rgba(0,0,0,.1)}
    .btn:active{transform:translateY(1px)}
    .btn.sub{background:#6c757d}
    .btn.info{background:var(--info)}
    .btn.ok{background:var(--ok)}
    .card{max-width:480px;margin:8px auto;background:#fff;border-radius:12px;padding:12px;box-shadow:0 2px 10px rgba(0,0,0,.06);text-align:left}
    video{width:100%;max-width:480px;border-radius:10px;background:#000}
    #status{margin-top:8px;color:#c0392b}
    #serial{margin-top:6px;color:var(--ok);font-weight:600}
    #top{display:block}
    #scanner{display:none}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px}
    
    /* ãŠçŸ¥ã‚‰ã›æ¬„ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
    .news-box {
      background-color: #e3f2fd;
      border-left: 5px solid #2196f3;
      padding: 10px;
      margin-top: 15px;
      text-align: left;
      border-radius: 4px;
      display: none; /* åˆæœŸã¯éè¡¨ç¤ºï¼ˆä¸­èº«ãŒã‚ã‚‹æ™‚ã ã‘å‡ºã™ï¼‰ */
    }
    .news-title { font-weight:bold; color:#1565c0; font-size:14px; margin-bottom:4px; }
    .news-content { font-size:14px; color:#333; white-space: pre-wrap; line-height: 1.4; }
  </style>
</head>
<body>

<div id="summaryCard" class="card" style="text-align:center; margin-bottom:12px;">
  <h2>ç‚¹æ¤œé€²æ—</h2>
  <p>äºˆå®šå°æ•°: <span id="planCount">-</span></p>
  <p>å®Œäº†å°æ•°: <span id="doneCount">-</span></p>
  <p>æ®‹å°æ•°: <span id="remainCount">-</span></p>
</div>

<div id="top">
  <h1>ç‚¹æ¤œè€…ã‚’é¸æŠ</h1>
  <div class="card" style="text-align:center">
    <button class="btn" onclick="startScan('ç¾½æŸ“')">ç¾½æŸ“</button>
    <button class="btn" onclick="startScan('æ¢…åŸ')">æ¢…åŸ</button>
    <button class="btn" onclick="startScan('æ˜ç”°å·')">æ˜ç”°å·</button>
    <button class="btn" onclick="startScan('å±±å£')">å±±å£</button>
    <button class="btn" onclick="startScan('ä½è—¤')">ä½è—¤</button>
    <button class="btn" onclick="startScan('é«™æ©‹')">é«™æ©‹</button>
    <button class="btn" onclick="startScan('é‡£å·')">é‡£å·</button>
    
    <hr style="margin: 15px 0; border: 0; border-top: 1px solid #eee;">

    <div style="display:flex; flex-direction:column; gap:8px;">
        <div style="display:flex; justify-content:center; gap:8px;">
            <button class="btn sub" style="margin:0; flex:1;" onclick="showHistory()">å±¥æ­´ã‚’è¦‹ã‚‹</button>
            <button class="btn sub" style="margin:0; flex:1;" onclick="openDashboard()">æœªé€ä¿¡å°ã‚’ç¢ºèª</button>
        </div>
        <button class="btn info" style="width:100%; margin:0;" onclick="openPastHistory()">ğŸ“‚ éå»ã®ç‚¹æ¤œå±¥æ­´</button>
    </div>

    <div id="newsArea" class="news-box">
        <div class="news-title">ğŸ“¢ ãŠçŸ¥ã‚‰ã›</div>
        <div id="newsText" class="news-content">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>

  </div>
</div>

<div id="scanner">
  <div class="card">
    <div class="toolbar">
      <button id="btnTorch" class="btn sub" style="display:none" onclick="onTorchClick()">ğŸ”¦ ãƒ©ã‚¤ãƒˆ</button>
      <button class="btn sub" onclick="manualEntry()">QRèª­ã‚ãªã„â†’æ‰‹å…¥åŠ›</button>
    </div>

    <video id="video" autoplay playsinline></video>
    <div id="status">QRã‚³ãƒ¼ãƒ‰ã‚’ã‹ã–ã—ã¦ãã ã•ã„â€¦</div>
    <div id="serial"></div>
  </div>
</div>

<script>
/** ====== è¨­å®š ====== */
const FORM_URL_BASE = "https://docs.google.com/forms/d/e/1FAIpQLSchpdG2NLN2uV5yAxyZC-k_xhFyem_KQDrhNmTMEGJGnsu13A/viewform";
const ENTRY_SERIAL   = "entry.797900650"; 
const ENTRY_INSPECT  = "entry.983313981";

/* === ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆé€£æº === */
const DASHBOARD_URL = "https://docs.google.com/spreadsheets/d/1YgPxoZnkJO402iSigrX893vd1ExJEPJobu7-_GzpW0w/edit?gid=2043079432#gid=2043079432";
// é€²æ—ï¼ˆB1:B3ï¼‰
const COUNTS_CSV_URL = "https://docs.google.com/spreadsheets/d/1YgPxoZnkJO402iSigrX893vd1ExJEPJobu7-_GzpW0w/export?format=csv&gid=2043079432&range=B1:B3";
// ãŠçŸ¥ã‚‰ã›ï¼ˆB5ï¼‰â† â˜…ã“ã“ã‚’æ–°è¨­ã—ã¾ã—ãŸã€‚B5ã‚»ãƒ«ã‚’èª­ã¿ã«è¡Œãã¾ã™ã€‚
const NEWS_CSV_URL   = "https://docs.google.com/spreadsheets/d/1YgPxoZnkJO402iSigrX893vd1ExJEPJobu7-_GzpW0w/export?format=csv&gid=2043079432&range=B5";

// éå»ã®ç‚¹æ¤œå±¥æ­´URL
const PAST_HISTORY_URL = "https://docs.google.com/spreadsheets/d/1w75zFfpDTkZ2ruyQz1g5f8_cnTe_SnIBCqKkOTuy9yc/edit?usp=drive_link";

/** ====== å¤‰æ•° ====== */
let inspector='', codeReader;
let streamTrack=null;
let torchSupported=false;

function yearDigitsToLetter(yyStr){
  const yy = Number(String(yyStr).replace(/\D/g, ''));
  if (!Number.isFinite(yy)) return '?';
  const baseIdx = 'H'.charCodeAt(0) - 'A'.charCodeAt(0);
  const idx = ((yy - 20) % 26 + 26) % 26;
  return String.fromCharCode('A'.charCodeAt(0) + ((baseIdx + idx) % 26));
}

function startScan(name){
  inspector = name;
  document.getElementById('top').style.display='none';
  document.getElementById('scanner').style.display='block';
  const summary = document.getElementById('summaryCard');
  if(summary) summary.style.display = 'none';

  codeReader = new ZXing.BrowserMultiFormatReader();
  const vid = document.getElementById('video');

  codeReader.decodeOnceFromConstraints({ video:{ facingMode:'environment' } }, vid)
  .then(res => {
    const raw = res.getText();
    const formatted = parseSerial(raw);
    document.getElementById('serial').textContent = 'èª­ã¿å–ã‚Š: ' + formatted;
    saveHistory(formatted);
    openForm(formatted);
    cleanupStream();
    setTimeout(() => location.reload(), 2000);
  })
  .catch(err => {
    document.getElementById('status').textContent = 'ã‚¨ãƒ©ãƒ¼: ' + err;
  });

  setTimeout(() => {
    try{
      const v = document.getElementById('video');
      const track = v.srcObject && v.srcObject.getVideoTracks ? v.srcObject.getVideoTracks()[0] : null;
      if(track){
        streamTrack = track;
        const caps = track.getCapabilities ? track.getCapabilities() : {};
        torchSupported = !!caps.torch; 
        const btn = document.getElementById('btnTorch');
        btn.style.display = torchSupported ? 'inline-block' : 'none';
      }
    }catch(e){ }
  }, 600);
}

function openForm(serial){
  const url = `${FORM_URL_BASE}?usp=pp_url&${ENTRY_SERIAL}=${encodeURIComponent(serial)}&${ENTRY_INSPECT}=${encodeURIComponent(inspector)}`;
  const win = window.open(url, '_blank');
  if(!win){ alert('ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™ã€‚'); }
}

function onTorchClick(){
  if(!torchSupported || !streamTrack) return;
  try{
    const settings = streamTrack.getSettings ? streamTrack.getSettings() : {};
    const isOn = settings.torch === true;
    streamTrack.applyConstraints({ advanced:[{ torch: !isOn }] }).catch(()=>{});
  }catch(e){ }
}

function manualEntry(){
  const url = `${FORM_URL_BASE}?usp=pp_url&${ENTRY_INSPECT}=${encodeURIComponent(inspector)}`;
  const win = window.open(url,'_blank');
  if(!win){ alert('ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™ã€‚'); }
}

function saveHistory(serial){
  const hist = JSON.parse(localStorage.getItem('history')||'[]');
  hist.unshift({time:new Date().toLocaleString(), serial, inspector});
  localStorage.setItem('history', JSON.stringify(hist.slice(0,500)));
}

function showHistory(){
  const RESPONSES_SHEET_URL = "https://docs.google.com/spreadsheets/d/1YgPxoZnkJO402iSigrX893vd1ExJEPJobu7-_GzpW0w/edit?gid=811114478#gid=811114478";
  window.open(RESPONSES_SHEET_URL, "_blank");
}

function openDashboard(){
  window.open(DASHBOARD_URL, "_blank");
}

/* â˜…æ–°æ©Ÿèƒ½: éå»ã®å±¥æ­´ã‚’é–‹ã */
function openPastHistory(){
  window.open(PAST_HISTORY_URL, "_blank");
}

/** B1:B3ï¼ˆæ•°å€¤ï¼‰ã¨ B5ï¼ˆãŠçŸ¥ã‚‰ã›ï¼‰ã‚’å–å¾— */
async function loadData(){
  // 1. æ•°å€¤å–å¾—
  try{
    const res = await fetch(COUNTS_CSV_URL, { cache: "no-store" });
    if(res.ok){
        const csv = await res.text();
        const rows = csv.trim().split(/\r?\n/).map(r => r.replace(/^"|"$|,/g,"").trim());
        const plan = parseInt(rows[0] || "0", 10) || 0;
        const done = parseInt(rows[1] || "0", 10) || 0;
        const remain = rows[2] && rows[2]!=="" ? (parseInt(rows[2],10)||0) : Math.max(0, plan - done);
        
        document.getElementById("planCount").textContent   = plan;
        document.getElementById("doneCount").textContent   = done;
        document.getElementById("remainCount").textContent = remain;
    }
  }catch(e){ console.warn("Counters load failed", e); }

  // 2. ãŠçŸ¥ã‚‰ã›å–å¾—ï¼ˆB5ã‚»ãƒ«ï¼‰
  try{
    const res = await fetch(NEWS_CSV_URL, { cache: "no-store" });
    if(res.ok){
        let text = await res.text();
        // CSVç‰¹æœ‰ã®ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆé™¤å»ãªã©
        text = text.trim().replace(/^"|"$/g, "").replace(/""/g, '"');
        
        const box = document.getElementById("newsArea");
        const content = document.getElementById("newsText");
        
        if(text && text.length > 0){
            content.textContent = text;
            box.style.display = "block"; // æ–‡å­—ãŒã‚ã‚‹æ™‚ã ã‘è¡¨ç¤º
        } else {
            box.style.display = "none";
        }
    }
  }catch(e){ console.warn("News load failed", e); }
}

window.addEventListener("load", () => {
  loadData();
});

function cleanupStream(){
  try{ codeReader && codeReader.reset(); }catch(e){}
  try{
    const v = document.getElementById('video');
    const tracks = v.srcObject && v.srcObject.getVideoTracks ? v.srcObject.getVideoTracks() : [];
    tracks.forEach(t => t.stop());
  }catch(e){}
}

function parseSerial(t){
  if (t == null) return t;
  t = String(t).trim();
  const head = t[0]?.toUpperCase() || '';
  const yyDigits = t.length >= 6 ? t.slice(4, 6) : '';
  const yearLetter = yearDigitsToLetter(yyDigits);
  const tail6 = (t.match(/(\d{6})$/) || [,''])[1] || '';
  const makerMatch = /^[PMCK].([A-Z]{2})/i.exec(t);
  const maker = makerMatch ? makerMatch[1].toUpperCase() : '';

  if (head === 'P' || head === 'M'){
    if (maker && yearLetter !== '?' && tail6){
      const prefix = (head === 'M') ? 'M' : '';
      return `${maker}-${yearLetter} ${prefix}${tail6}`;
    }
    return t; 
  }
  if (head === 'C' || head === 'K'){
    if (/[0321]/.test(t[1] || '') && maker && yearLetter !== '?' && tail6){
      return `${maker}-${yearLetter} ${head}${tail6}`;
    }
    return t; 
  }
  return t;
}
</script>
</body>
</html>
