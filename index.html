<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>ç‚¹æ¤œçµæœå ±å‘Šã‚¢ãƒ—ãƒªï¼ˆå¹´ã‚³ãƒ¼ãƒ‰è‡ªå‹•åˆ¤å®šãƒ»çµ±ä¸€é·ç§»ï¼‰</title>
  <!-- ã‚¿ãƒ–ã®ãƒ•ã‚¡ãƒ“ã‚³ãƒ³ -->
<link rel="icon" type="image/png" href="ã‚¢ãƒ—ãƒªãƒ­ã‚´.png">

<!-- iPhoneã®ãƒ›ãƒ¼ãƒ ç”»é¢ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆæ¨å¥¨ï¼š180Ã—180ã®æ­£æ–¹å½¢ï¼‰ -->
<link rel="apple-touch-icon" href="ã‚¢ãƒ—ãƒªãƒ­ã‚´.png">

<!--ï¼ˆä»»æ„ï¼‰ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼ã®è‰² -->
<meta name="theme-color" content="#007bff">

  <script src="https://unpkg.com/@zxing/library@latest"></script>
  <style>
    :root { --brand:#007bff; --ok:#28a745; --danger:#e55353; }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#f5f6f8;text-align:center;padding:16px}
    h1{margin:8px 0 12px;color:#222}
    .btn{margin:6px;padding:10px 16px;font-size:16px;border:none;border-radius:10px;background:var(--brand);color:#fff;box-shadow:0 2px 6px rgba(0,0,0,.1)}
    .btn:active{transform:translateY(1px)}
    .btn.sub{background:#6c757d}
    .btn.ok{background:var(--ok)}
    .card{max-width:480px;margin:8px auto;background:#fff;border-radius:12px;padding:12px;box-shadow:0 2px 10px rgba(0,0,0,.06);text-align:left}
    video{width:100%;max-width:480px;border-radius:10px;background:#000}
    #status{margin-top:8px;color:#c0392b}
    #serial{margin-top:6px;color:var(--ok);font-weight:600}
    #top{display:block}
    #scanner{display:none}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px}
    .statline{padding:4px 0;font-size:15px}

  </style>
</head>
<body>
 <!-- é€²æ—ã‚µãƒãƒªè¡¨ç¤º -->
<div id="summaryCard" class="card" style="text-align:center; margin-bottom:12px;">
  <h2>ç‚¹æ¤œé€²æ—</h2>
  <p>äºˆå®šå°æ•°: <span id="planCount">-</span></p>
  <p>å®Œäº†å°æ•°: <span id="doneCount">-</span></p>
  <p>æ®‹å°æ•°: <span id="remainCount">-</span></p>
</div>

  <div id="top">
    <h1>ç‚¹æ¤œè€…ã‚’é¸æŠ</h1>
    <div class="card" style="text-align:center">
      <button class="btn" onclick="startScan('ç¾½æŸ“')">ç¾½æŸ“</button>
      <button class="btn" onclick="startScan('æ¢…åŸ')">æ¢…åŸ</button>
      <button class="btn" onclick="startScan('æ˜ç”°å·')">æ˜ç”°å·</button>
      <button class="btn" onclick="startScan('å±±å£')">å±±å£</button>
      <button class="btn" onclick="startScan('ä½è—¤')">ä½è—¤</button>
      <button class="btn" onclick="startScan('é«™æ©‹')">é«™æ©‹</button>
      <button class="btn" onclick="startScan('é‡£å·')">é‡£å·</button>
      
      <div style="margin-top:10px">
  <button class="btn sub" onclick="showHistory()">å±¥æ­´ã‚’è¦‹ã‚‹</button>
  <button class="btn sub" onclick="openDashboard()">ç‚¹æ¤œé€²æ—ã‚’ç¢ºèª</button>
</div>

    </div>
  </div>

  <div id="scanner">
    <div class="card">
      <div class="toolbar">
        <button id="btnTorch" class="btn sub" style="display:none" onclick="onTorchClick()">ğŸ”¦ ãƒ©ã‚¤ãƒˆ</button>
        <button class="btn sub" onclick="manualEntry()">QRèª­ã‚ãªã„â†’æ‰‹å…¥åŠ›</button>
      </div>

      <video id="video" autoplay playsinline></video>
      <div id="status">QRã‚³ãƒ¼ãƒ‰ã‚’ã‹ã–ã—ã¦ãã ã•ã„â€¦</div>
      <div id="serial"></div>
    </div>
  </div>

<script>
/** ====== è¨­å®š ====== */
const FORM_URL_BASE = "https://docs.google.com/forms/d/e/1FAIpQLSchpdG2NLN2uV5yAxyZC-k_xhFyem_KQDrhNmTMEGJGnsu13A/viewform";
const ENTRY_SERIAL   = "entry.797900650"; // è£½é€ ç•ªå·
const ENTRY_INSPECT  = "entry.983313981"; // ç‚¹æ¤œè€…

/* === Dashboard é€£æºï¼ˆæ•°å€¤å–å¾—ï¼†ã‚¸ãƒ£ãƒ³ãƒ—ï¼‰ === */
const DASHBOARD_URL = "https://docs.google.com/spreadsheets/d/1YgPxoZnkJO402iSigrX893vd1ExJEPJobu7-_GzpW0w/edit?gid=2043079432#gid=2043079432";
const COUNTS_CSV_URL = "https://docs.google.com/spreadsheets/d/1YgPxoZnkJO402iSigrX893vd1ExJEPJobu7-_GzpW0w/export?format=csv&gid=2043079432&range=B1:B3";


/** ====== å¤‰æ•° ====== */
let inspector='', codeReader;
let streamTrack=null;             // ç¾åœ¨ã®ã‚«ãƒ¡ãƒ©ãƒˆãƒ©ãƒƒã‚¯ï¼ˆtorchåˆ¶å¾¡ã«ä½¿ç”¨ï¼‰
let torchSupported=false;         // ã“ã®ç«¯æœ«/ã‚«ãƒ¡ãƒ©ã§ãƒã‚¤ãƒ†ã‚£ãƒ–torchãŒä½¿ãˆã‚‹ã‹

/** ====== å¹´ã‚³ãƒ¼ãƒ‰ â†’ æ–‡å­—ï¼ˆJ,K,L,M,N,â€¦Z, Aâ€¦ï¼‰ ======
 * åŸºæº–: 2022å¹´â†’'J'ã€‚ä»¥é™ã¯ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆé †ã«é€²ã‚€ï¼ˆZã®æ¬¡ã¯Aï¼‰ã€‚
 * ä¾‹: 2022â†’J, 2023â†’K, 2024â†’L, 2025â†’M, 2026â†’N
 */
function yearDigitsToLetter(yyStr){
  const yy = Number(String(yyStr).replace(/\D/g, '')); // "24" ç­‰
  if (!Number.isFinite(yy)) return '?';
  // 2020â†’H ã‚’èµ·ç‚¹ã« 26 æ–‡å­—ã‚’å¾ªç’°ï¼ˆâ€¦Z ã®æ¬¡ã¯ Aï¼‰
  const baseIdx = 'H'.charCodeAt(0) - 'A'.charCodeAt(0); // 7
  const idx = ((yy - 20) % 26 + 26) % 26;                // 0..25
  return String.fromCharCode('A'.charCodeAt(0) + ((baseIdx + idx) % 26));
}

/** ====== ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹ ====== */
function startScan(name){
  inspector = name;
  document.getElementById('top').style.display='none';
  document.getElementById('scanner').style.display='block';
  // é€²æ—ã‚µãƒãƒªã‚’éè¡¨ç¤ºã«ã™ã‚‹
const summary = document.getElementById('summaryCard');
if(summary) summary.style.display = 'none';

  codeReader = new ZXing.BrowserMultiFormatReader();
  const vid = document.getElementById('video');

  // ZXing ã«ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’é–‹ã‹ã›ã‚‹ï¼ˆèƒŒé¢ã‚«ãƒ¡ãƒ©æŒ‡å®šï¼‰
  codeReader.decodeOnceFromConstraints({ video:{ facingMode:'environment' } }, vid)
  .then(res => {
    const raw = res.getText();
    const formatted = parseSerial(raw); // å¤‰æ›
    document.getElementById('serial').textContent = 'èª­ã¿å–ã‚Š: ' + formatted;
    saveHistory(formatted);
    openForm(formatted);               // çµ±ä¸€ï¼šåˆ¥ã‚¿ãƒ–ã§é–‹ã
    cleanupStream();
    setTimeout(() => location.reload(), 2000);
  })
  .catch(err => {
    document.getElementById('status').textContent = 'ã‚¨ãƒ©ãƒ¼: ' + err;
  });

  // å°‘ã—å¾…ã£ã¦ video ã«ã‚¹ãƒˆãƒªãƒ¼ãƒ ãŒä¹—ã£ãŸå¾Œã« torch å¯å¦ã‚’åˆ¤å®š
  setTimeout(() => {
    try{
      const v = document.getElementById('video');
      const track = v.srcObject && v.srcObject.getVideoTracks ? v.srcObject.getVideoTracks()[0] : null;
      if(track){
        streamTrack = track;
        const caps = track.getCapabilities ? track.getCapabilities() : {};
        torchSupported = !!caps.torch; // iOSã¯æœªå¯¾å¿œã®ãŸã‚falseã®ã¾ã¾ã«ãªã‚‹
        const btn = document.getElementById('btnTorch');
        btn.style.display = torchSupported ? 'inline-block' : 'none';
      }
    }catch(e){ /* ignore */ }
  }, 600);
}

/** ====== ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‹ãï¼ˆçµ±ä¸€ã—ã¦åˆ¥ã‚¿ãƒ–ï¼‰ ====== */
function openForm(serial){
  const url = `${FORM_URL_BASE}?usp=pp_url&${ENTRY_SERIAL}=${encodeURIComponent(serial)}&${ENTRY_INSPECT}=${encodeURIComponent(inspector)}`;
  const win = window.open(url, '_blank');
  if(!win){
    alert('ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™ã€‚ãƒ–ãƒ©ã‚¦ã‚¶è¨­å®šã§è¨±å¯ã—ã¦ãã ã•ã„ã€‚');
  }
}

/** ====== ãƒ©ã‚¤ãƒˆï¼ˆå¯¾å¿œç«¯æœ«ã®ã¿ï¼‰ ====== */
function onTorchClick(){
  if(!torchSupported || !streamTrack) return;
  try{
    const settings = streamTrack.getSettings ? streamTrack.getSettings() : {};
    const isOn = settings.torch === true;
    streamTrack.applyConstraints({ advanced:[{ torch: !isOn }] }).catch(()=>{});
  }catch(e){ /* ignore */ }
}

/** ====== æ‰‹å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ ====== */
function manualEntry(){
  const url = `${FORM_URL_BASE}?usp=pp_url&${ENTRY_INSPECT}=${encodeURIComponent(inspector)}`;
  const win = window.open(url,'_blank');
  if(!win){ alert('ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™ã€‚ãƒ–ãƒ©ã‚¦ã‚¶è¨­å®šã§è¨±å¯ã—ã¦ãã ã•ã„ã€‚'); }
}

/** ====== å±¥æ­´ ====== */
function saveHistory(serial){
  const hist = JSON.parse(localStorage.getItem('history')||'[]');
  hist.unshift({time:new Date().toLocaleString(), serial, inspector});
  localStorage.setItem('history', JSON.stringify(hist.slice(0,500)));
}
function showHistory(){
  const RESPONSES_SHEET_URL = "https://docs.google.com/spreadsheets/d/1YgPxoZnkJO402iSigrX893vd1ExJEPJobu7-_GzpW0w/edit?gid=811114478#gid=811114478";
  const w = window.open(RESPONSES_SHEET_URL, "_blank");
  if(!w){
    alert("ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™ã€‚ãƒ–ãƒ©ã‚¦ã‚¶è¨­å®šã§è¨±å¯ã—ã¦ãã ã•ã„ã€‚");
  }
}

/** Dashboard ã‚’æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ãï¼ˆãƒœã‚¿ãƒ³ç”¨ï¼‰ */
function openProgress(){
  const w = window.open(DASHBOARD_URL, "_blank");
  if(!w){ alert("ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™ã€‚ãƒ–ãƒ©ã‚¦ã‚¶è¨­å®šã§è¨±å¯ã—ã¦ãã ã•ã„ã€‚"); }
}

/** B1:B3ï¼ˆäºˆå®š/å®Œäº†/æ®‹ï¼‰ã‚’CSVã§å–å¾—ã—ã¦TOPã«è¡¨ç¤º */
async function loadCounters(){
  try{
    const res = await fetch(COUNTS_CSV_URL, { cache: "no-store" });
    if(!res.ok) throw new Error("HTTP "+res.status);
    const csv = await res.text();

    // 1åˆ—CSVæƒ³å®šï¼š1è¡Œç›®=B1(äºˆå®š), 2è¡Œç›®=B2(å®Œäº†), 3è¡Œç›®=B3(æ®‹)
    const rows = csv.trim().split(/\r?\n/).map(r => r.replace(/^"|"$|,/g,"").trim());
    const plan = parseInt(rows[0] || "0", 10) || 0;
    const done = parseInt(rows[1] || "0", 10) || 0;
    // B3 ã«å€¤ãŒã‚ã‚‹ãªã‚‰ãã‚Œã‚’å„ªå…ˆã€ç„¡ã„ãªã‚‰ plan-done ã§è¨ˆç®—
    const remain = rows[2] && rows[2]!=="" ? (parseInt(rows[2],10)||0) : Math.max(0, plan - done);

    document.getElementById("planCount").textContent   = plan;
    document.getElementById("doneCount").textContent   = done;
    document.getElementById("remainCount").textContent = remain;
  }catch(e){
    // å–å¾—ã§ããªã„ï¼ˆæ¨©é™/URL/ãƒãƒƒãƒˆï¼‰æ™‚ã¯ãƒ€ãƒƒã‚·ãƒ¥ã‚’è¡¨ç¤º
    document.getElementById("planCount").textContent   = "-";
    document.getElementById("doneCount").textContent   = "-";
    document.getElementById("remainCount").textContent = "-";
    // console.warn("loadCounters failed:", e);
  }
}

/** ç”»é¢èª­ã¿è¾¼ã¿æ™‚ã«ä¸€åº¦è‡ªå‹•æ›´æ–°ï¼ˆå¤±æ•—ã—ã¦ã‚‚ç„¡è¦–ï¼‰ */
window.addEventListener("load", () => {
  loadCounters();
});
  
  /** ====== Dashboard ã‚·ãƒ¼ãƒˆã‚’é–‹ã ====== */
function openDashboard(){
  const DASHBOARD_URL = "https://docs.google.com/spreadsheets/d/1YgPxoZnkJO402iSigrX893vd1ExJEPJobu7-_GzpW0w/edit?gid=2043079432#gid=2043079432";
  const w = window.open(DASHBOARD_URL, "_blank");
  if(!w){
    alert("ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™ã€‚ãƒ–ãƒ©ã‚¦ã‚¶è¨­å®šã§è¨±å¯ã—ã¦ãã ã•ã„ã€‚");
  }
}



/** ====== å¾Œå§‹æœ« ====== */
function cleanupStream(){
  try{ codeReader && codeReader.reset(); }catch(e){}
  try{
    const v = document.getElementById('video');
    const tracks = v.srcObject && v.srcObject.getVideoTracks ? v.srcObject.getVideoTracks() : [];
    tracks.forEach(t => t.stop());
  }catch(e){}
}

/** ====== å¤‰æ›ãƒ­ã‚¸ãƒƒã‚¯ ======
 * 1) ãƒ‘ãƒãƒ³ã‚³ï¼ˆP/M å§‹ã¾ã‚Šï¼‰: å…ˆé ­(P|M), 2, ãƒ¡ãƒ¼ã‚«ãƒ¼2å­—, å¹´(2æ¡), â€¦, æœ«å°¾6æ¡ãŒè£½é€ ç•ªå·
 *    - å¹´â†’è¨˜å·: yearToLetterFromYYï¼ˆä¾‹ 22:J, 23:K, 24:L, 25:M, 26:N ... Zâ†’Aï¼‰
 *    - ã‚¹ãƒãƒ‘ãƒ(M)ã¯è£½é€ ç•ªå·ã®å‰ã« 'M' ã‚’ä»˜åŠ 
 * 2) ã‚¹ãƒ­ãƒƒãƒˆï¼ˆæ—¥å·¥çµ„ã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ä¾‹ï¼‰: ^[A-Z0-9]{2}([A-Z]{2})\d{9}$
 *    - ä¾‹: C0DA230008944 â†’ DA-K C008944
 *    - ãƒ¡ãƒ¼ã‚«ãƒ¼ã”ã¨ã®ã‚¯ãƒ©ã‚¹è¨˜å·ã¯ classMap ã§ç®¡ç†ï¼ˆå¿…è¦ã«å¿œã˜ã¦æ‹¡å¼µï¼‰
 * 3) ã‚¹ãƒ­ãƒƒãƒˆï¼ˆæ—¥é›»å”ãªã© â€œäººãŒèª­ã‚€ç•ªå·â€ï¼‰: åŸæ–‡ã®ã¾ã¾
 */
function parseSerial(t){
  if (t == null) return t;
  t = String(t).trim();

  // å…±é€šï¼šå…ˆé ­1æ–‡å­—ï¼ˆç³»çµ±ï¼‰ãƒ»5,6æ¡ç›®ã®å¹´ãƒ»æœ«å°¾6æ¡
  const head = t[0]?.toUpperCase() || '';
  const yyDigits = t.length >= 6 ? t.slice(4, 6) : '';
  const yearLetter = yearDigitsToLetter(yyDigits);
  const tail6 = (t.match(/(\d{6})$/) || [,''])[1] || '';

  // ãƒ¡ãƒ¼ã‚«ãƒ¼2å­—ã¯ã€Œå…ˆé ­1æ–‡å­—ï¼‹2æ¡ç›®ã®éƒ¨ä½ã€ã®æ¬¡ã®2å­—ï¼ˆä¾‹ï¼šP1**WW**24..., C0**HC**22...ï¼‰
  const makerMatch = /^[PMCK].([A-Z]{2})/i.exec(t);
  const maker = makerMatch ? makerMatch[1].toUpperCase() : '';

  /* ===== ãƒ‘ãƒãƒ³ã‚³ï¼ˆP/Mï¼‰===== */
  if (head === 'P' || head === 'M'){
    if (maker && yearLetter !== '?' && tail6){
      const prefix = (head === 'M') ? 'M' : ''; // ã‚¹ãƒãƒ‘ãƒã¯è£½ç•ªå‰ã« M
      return `${maker}-${yearLetter} ${prefix}${tail6}`;
    }
    return t; // å–ã‚Šåˆ‡ã‚Œãªã‘ã‚Œã°ç´ é€šã—
  }

  /* ===== ã‚¹ãƒ­ãƒƒãƒˆï¼ˆæ—¥å·¥çµ„ï¼šC/Kï¼‰===== */
  if (head === 'C' || head === 'K'){
    // 2æ¡ç›®ã¯éƒ¨ä½ã‚³ãƒ¼ãƒ‰ï¼š0=æœ¬ä½“ / 3=å›èƒ´ / 2=ç­ä½“ / 1=ä¸»åŸºæ¿ï¼ˆå‡ºåŠ›ã«ã¯ä½¿ã‚ãªã„ï¼‰
    if (/[0321]/.test(t[1] || '') && maker && yearLetter !== '?' && tail6){
      return `${maker}-${yearLetter} ${head}${tail6}`;
    }
    return t; // æ—¥é›»å”ãªã©å¯èª­å½¢å¼ã¯ç´ é€šã—
  }

  /* ===== ãã®ä»–ï¼ˆç´ é€šã—ï¼‰===== */
  return t;
}
</script>
</body>
</html>
