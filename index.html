<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>ç‚¹æ¤œã‚¢ãƒ—ãƒªï¼ˆå†™çœŸï¼†QRé€£æºç‰ˆï¼‰</title>
  <link rel="icon" type="image/png" href="ã‚¢ãƒ—ãƒªãƒ­ã‚´.png">
  <link rel="apple-touch-icon" href="ã‚¢ãƒ—ãƒªãƒ­ã‚´.png">
  <meta name="theme-color" content="#007bff">
  <script src="https://unpkg.com/@zxing/library@latest"></script>
  <style>
    :root { --brand:#007bff; --ok:#28a745; --danger:#e55353; --info:#17a2b8; }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#f5f6f8;text-align:center;padding:16px}
    h1{margin:8px 0 12px;color:#222}
    .btn{margin:6px;padding:12px 20px;font-size:16px;border:none;border-radius:10px;background:var(--brand);color:#fff;box-shadow:0 2px 6px rgba(0,0,0,.1)}
    .btn:active{transform:translateY(1px)}
    .btn.sub{background:#6c757d; padding:8px 16px; font-size:14px;}
    .btn.info{background:var(--info)}
    .card{max-width:480px;margin:8px auto;background:#fff;border-radius:12px;padding:12px;box-shadow:0 2px 10px rgba(0,0,0,.06);text-align:left}
    
    video, canvas {width:100%;max-width:480px;border-radius:10px;background:#000; display:none;}
    
    #status{margin-top:8px;color:#c0392b; font-weight:bold;}
    #serial{margin-top:6px;color:var(--ok);font-weight:600}
    
    /* ç”»é¢åˆ‡ã‚Šæ›¿ãˆç”¨ */
    .view-section { display:none; }
    .view-section.active { display:block; }

    /* å†™çœŸãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ */
    #photoPreview { width:100%; border-radius:10px; margin-bottom:10px; border:2px solid #ccc; display:none;}

    /* ãŠçŸ¥ã‚‰ã›æ¬„ */
    .news-box {
      background-color: #fff3cd; border-left: 5px solid #ffc107;
      padding: 10px; margin-top: 15px; text-align: left; border-radius: 4px; display: none;
    }
    .news-title { font-weight:bold; color:#856404; font-size:14px; margin-bottom:6px; border-bottom:1px solid rgba(0,0,0,0.1); padding-bottom:4px;}
    .news-content ul { padding-left: 20px; margin: 0; }
    .news-content li { margin-bottom: 4px; font-size:14px;}
  </style>
</head>
<body>

<div id="summaryCard" class="card" style="text-align:center; margin-bottom:12px;">
  <h2>ç‚¹æ¤œé€²æ—</h2>
  <p>äºˆå®š: <span id="planCount">-</span> / å®Œäº†: <span id="doneCount">-</span> / æ®‹: <span id="remainCount">-</span></p>
</div>

<div id="view-top" class="view-section active">
  <h1>ç‚¹æ¤œè€…ã‚’é¸æŠ</h1>
  <div class="card" style="text-align:center">
    <div>
        <button class="btn" onclick="startFlow('ç¾½æŸ“')">ç¾½æŸ“</button>
        <button class="btn" onclick="startFlow('æ¢…åŸ')">æ¢…åŸ</button>
        <button class="btn" onclick="startFlow('æ˜ç”°å·')">æ˜ç”°å·</button>
        <button class="btn" onclick="startFlow('å±±å£')">å±±å£</button>
        <button class="btn" onclick="startFlow('ä½è—¤')">ä½è—¤</button>
        <button class="btn" onclick="startFlow('é«™æ©‹')">é«™æ©‹</button>
        <button class="btn" onclick="startFlow('é‡£å·')">é‡£å·</button>
    </div>
    <hr style="margin: 15px 0; border: 0; border-top: 1px solid #eee;">
    
    <div style="display:flex; justify-content:center; gap:8px;">
        <button class="btn sub" onclick="showHistory()">å±¥æ­´</button>
        <button class="btn sub" onclick="openDashboard()">æœªé€ä¿¡</button>
    </div>
    <div style="margin-top:8px;">
        <button class="btn info" style="width:100%;" onclick="openPastHistory()">ğŸ“‚ éå»ã®å±¥æ­´</button>
    </div>

    <div id="newsArea" class="news-box">
        <div class="news-title">ğŸ“¢ ãŠçŸ¥ã‚‰ã›</div>
        <div id="newsText" class="news-content"></div>
    </div>
  </div>
</div>

<div id="view-camera" class="view-section">
    <div class="card" style="text-align:center;">
        <h3>â‘  ãƒˆãƒƒãƒ—ãƒ¦ãƒ‹ãƒƒãƒˆã‚’è£…ç€ã—ãŸéŠæŠ€å°ã‚’æ’®å½±</h3>
        <video id="cameraVideo" autoplay playsinline></video>
        <img id="photoPreview" />
        <canvas id="cameraCanvas"></canvas>
        
        <div style="margin-top:10px;">
            <button id="btnShutter" class="btn" onclick="takePhoto()">ğŸ“· æ’®å½±ã™ã‚‹</button>
            
            <button id="btnSkip" class="btn sub" style="background:#17a2b8;" onclick="skipPhoto()">â­ï¸ QRã‚³ãƒ¼ãƒ‰èª­è¾¼ã¸</button>

            <button id="btnRetake" class="btn sub" style="display:none;" onclick="retakePhoto()">æ’®ã‚Šç›´ã™</button>
            <button id="btnNextScan" class="btn ok" style="display:none;" onclick="goToScan()">OKï¼æ¬¡ã¸é€²ã‚€</button>
        </div>
        
        <div style="margin-top:15px; border-top:1px solid #eee; padding-top:10px;">
            <button class="btn sub" style="background:#999;" onclick="resetToTop()">ä¸­æ­¢ã—ã¦æˆ»ã‚‹</button>
        </div>
    </div>
</div>

<div id="view-scan" class="view-section">
  <div class="card">
    <h3>â‘¡ QRã‚’ã‚¹ã‚­ãƒ£ãƒ³</h3>
    <div class="toolbar" style="justify-content:center;">
      <button id="btnTorch" class="btn sub" style="display:none" onclick="onTorchClick()">ğŸ”¦ ãƒ©ã‚¤ãƒˆ</button>
      <button class="btn sub" onclick="manualEntry()">æ‰‹å…¥åŠ›</button>
    </div>

    <video id="scannerVideo" autoplay playsinline style="display:block;"></video>
    <div id="status">QRã‚³ãƒ¼ãƒ‰ã‚’ã‹ã–ã—ã¦ãã ã•ã„â€¦</div>
    <div id="serial"></div>
  </div>
</div>

<div id="view-sending" class="view-section">
    <div class="card" style="text-align:center; padding:40px;">
        <h2 id="msgSending">å‡¦ç†ä¸­...</h2>
        <p id="msgDetail">ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†ã—ã¦ã„ã¾ã™ã€‚<br>ç”»é¢ã‚’é–‰ã˜ãªã„ã§ãã ã•ã„ã€‚</p>
        <div style="font-size:30px;">â³</div>
    </div>
</div>

<script>
/** ====== è¨­å®š ====== */
// â˜…ã“ã“ã« GASã®ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªURL ã‚’è²¼ã‚Šç›´ã—ã¦ãã ã•ã„ï¼
const GAS_API_URL = "https://script.google.com/macros/s/xxxxxxxxxxxxxxxxx/exec";

const FORM_URL_BASE = "https://docs.google.com/forms/d/e/1FAIpQLSchpdG2NLN2uV5yAxyZC-k_xhFyem_KQDrhNmTMEGJGnsu13A/viewform";
const ENTRY_SERIAL   = "entry.797900650"; 
const ENTRY_INSPECT  = "entry.983313981";

/* ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆé€£æºURL */
const DASHBOARD_URL = "https://docs.google.com/spreadsheets/d/1YgPxoZnkJO402iSigrX893vd1ExJEPJobu7-_GzpW0w/edit?gid=2043079432#gid=2043079432";
const COUNTS_CSV_URL = "https://docs.google.com/spreadsheets/d/1YgPxoZnkJO402iSigrX893vd1ExJEPJobu7-_GzpW0w/export?format=csv&gid=2043079432&range=B1:B3";
const NEWS_CSV_URL   = "https://docs.google.com/spreadsheets/d/1YgPxoZnkJO402iSigrX893vd1ExJEPJobu7-_GzpW0w/export?format=csv&gid=1607150139&range=A1:A5";
const PAST_HISTORY_URL = "https://docs.google.com/spreadsheets/d/1w75zFfpDTkZ2ruyQz1g5f8_cnTe_SnIBCqKkOTuy9yc/edit?usp=drive_link";

/** å¤‰æ•° */
let inspector='';
let codeReader;
let streamTrack=null;
let capturedImageBase64 = null; // æ’®å½±ã—ãŸå†™çœŸãƒ‡ãƒ¼ã‚¿

/* === 1. æ’®å½±ãƒ•ãƒ­ãƒ¼é–‹å§‹ === */
function startFlow(name){
    inspector = name;
    switchView('view-camera');
    startCamera(); // æ’®å½±ç”¨ã‚«ãƒ¡ãƒ©èµ·å‹•
}

/* === ç”»é¢åˆ‡ã‚Šæ›¿ãˆãƒ˜ãƒ«ãƒ‘ãƒ¼ === */
function switchView(id){
    document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
    document.getElementById(id).classList.add('active');
}

/* === ã‚«ãƒ¡ãƒ©å‡¦ç†ï¼ˆå†™çœŸæ’®å½±ç”¨ï¼‰ === */
async function startCamera(){
    const video = document.getElementById('cameraVideo');
    video.style.display = 'block';
    document.getElementById('photoPreview').style.display = 'none';
    
    // ãƒœã‚¿ãƒ³ã®åˆæœŸçŠ¶æ…‹
    document.getElementById('btnShutter').style.display = 'inline-block';
    document.getElementById('btnSkip').style.display = 'inline-block'; // â˜…ã‚¹ã‚­ãƒƒãƒ—è¡¨ç¤º
    document.getElementById('btnRetake').style.display = 'none';
    document.getElementById('btnNextScan').style.display = 'none';

    try {
        const stream = await navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: 'environment' }, 
            audio: false 
        });
        video.srcObject = stream;
    } catch(err) {
        alert("ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã§ãã¾ã›ã‚“ã§ã—ãŸ: " + err);
    }
}

function takePhoto(){
    const video = document.getElementById('cameraVideo');
    const canvas = document.getElementById('cameraCanvas');
    const context = canvas.getContext('2d');
    
    // ç¾åœ¨ã®ãƒ“ãƒ‡ã‚ªã‚µã‚¤ã‚ºã«åˆã‚ã›ã‚‹
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    context.drawImage(video, 0, 0, canvas.width, canvas.height);
